# Dependencies Schema
# This file documents the required structure for dependencies.yaml
# Generated by Phase 1 (Discovery) and consumed by Phase 2 (Generation)

# ============================================================================
# SCHEMA VERSION
# ============================================================================
# version: "1.0"  # Schema version for compatibility

# ============================================================================
# METADATA
# ============================================================================
# generated: ISO 8601 timestamp when file was created
# target_service: Name of the service being analyzed
# target_path: Directory path that was analyzed

# ============================================================================
# DOCUMENTATION SOURCES
# ============================================================================
# documentation:
#   runbook: Path to runbook file (if found)
#   architecture: Path to architecture doc (if found)
#   readme: Path to README (if found)
#   notes: Any important context extracted from docs

# ============================================================================
# SERVICE DEFINITION
# ============================================================================
# service:
#   name: Human-readable service name (Title Case, no abbreviations)
#   description: Brief description of what the service does
#   entrypoints:
#     - type: "grpc" | "http" | "kafka" | "cron"
#       name: Name of the entrypoint (e.g., "LedgerService" for gRPC)
#       proto: Path to proto file (for gRPC)
#       path: API path prefix (for HTTP)
#       topic: Topic name (for Kafka consumers as entry)
#       methods:
#         - List of method/endpoint names

# ============================================================================
# SYNC DEPENDENCIES (gRPC, HTTP, Database)
# ============================================================================
# dependencies:
#   sync:
#     - name: Target service/system name (Title Case)
#       type: "grpc" | "http" | "database" | "cache"
#
#       # For gRPC
#       proto: Proto service name (e.g., "PaymentService")
#       methods_called:
#         - List of RPC methods called
#
#       # For HTTP
#       base_url: Base URL or service name
#       endpoints_called:
#         - List of endpoints called
#
#       # For Database
#       connection: Connection/database name
#       operations:
#         - "read" | "write" | "read/write"
#
#       # For Cache
#       purpose: What is cached
#
#       # Source tracing (REQUIRED)
#       source_file: Path to file where this dependency is used
#       source_line: Line number
#
#       # Configuration (if known)
#       timeout: Timeout value (e.g., "5s")
#       retry: true | false
#       circuit_breaker: true | false

# ============================================================================
# ASYNC DEPENDENCIES (Kafka, Message Queues)
# ============================================================================
#   async:
#     - name: Topic name (lowercase, dot-separated)
#       type: "kafka" | "rabbitmq" | "sqs" | "pubsub"
#       direction: "produce" | "consume"
#
#       # For consumers
#       consumer_group: Consumer group name
#
#       # Error handling
#       dlq: true | false (has dead letter queue)
#       dlq_topic: DLQ topic name (if applicable)
#
#       # Source tracing (REQUIRED)
#       source_file: Path to file
#       source_line: Line number

# ============================================================================
# INBOUND CALLERS (Services that call this service)
# ============================================================================
# callers:
#   - name: Calling service name
#     type: "grpc" | "http" | "kafka"
#     methods_called:
#       - Methods/endpoints they call on this service
#     source: "from runbook" | "from proto import" | "from code"

# ============================================================================
# EXTERNAL SYSTEMS (Third-party APIs)
# ============================================================================
# external:
#   - name: System name (e.g., "Stripe API")
#     type: "https" | "grpc" | "sdk"
#     purpose: What it's used for
#     source_file: Path to client code
#     source_line: Line number

# ============================================================================
# CACHES
# ============================================================================
# caches:
#   - name: Cache system (e.g., "Redis", "Memcached")
#     purpose: What is being cached
#     source_file: Path to cache code
#     source_line: Line number

# ============================================================================
# FULL EXAMPLE
# ============================================================================
example:
  version: "1.0"
  generated: "2024-01-15T14:30:22Z"
  target_service: "ledger-service"
  target_path: "services/ledger/"

  documentation:
    runbook: "services/ledger/docs/RUNBOOK.md"
    architecture: "services/ledger/docs/architecture.md"
    notes: "Core financial service, handles all transaction records"

  service:
    name: "Ledger Service"
    description: "Manages financial transactions and account balances"
    entrypoints:
      - type: "grpc"
        name: "LedgerService"
        proto: "proto/ledger.proto"
        methods:
          - "CreateTransaction"
          - "GetBalance"
          - "ListTransactions"
      - type: "http"
        path: "/api/v1/ledger"
        methods:
          - "GET /health"
          - "POST /webhook/stripe"

  dependencies:
    sync:
      - name: "Payment Service"
        type: "grpc"
        proto: "PaymentService"
        methods_called:
          - "ProcessPayment"
          - "RefundPayment"
        source_file: "internal/client/payment_client.go"
        source_line: 45
        timeout: "5s"
        retry: true
        circuit_breaker: true

      - name: "PostgreSQL"
        type: "database"
        connection: "ledger_db"
        operations:
          - "read"
          - "write"
        source_file: "internal/repository/ledger_repo.go"
        source_line: 12

      - name: "Redis"
        type: "cache"
        purpose: "Balance cache for fast reads"
        source_file: "internal/cache/balance_cache.go"
        source_line: 18

    async:
      - name: "order.completed"
        type: "kafka"
        direction: "consume"
        consumer_group: "ledger-order-consumer"
        dlq: true
        dlq_topic: "order.completed.dlq"
        source_file: "internal/consumer/order_consumer.go"
        source_line: 27

      - name: "ledger.transaction.created"
        type: "kafka"
        direction: "produce"
        source_file: "internal/producer/transaction_producer.go"
        source_line: 34

      - name: "ledger.balance.updated"
        type: "kafka"
        direction: "produce"
        source_file: "internal/producer/balance_producer.go"
        source_line: 22

  callers:
    - name: "Order Service"
      type: "grpc"
      methods_called:
        - "CreateTransaction"
      source: "from runbook"

    - name: "Reporting Service"
      type: "grpc"
      methods_called:
        - "ListTransactions"
        - "GetBalance"
      source: "from proto import in services/reporting/"

  external:
    - name: "Stripe API"
      type: "https"
      purpose: "Payment webhook verification"
      source_file: "internal/webhook/stripe_handler.go"
      source_line: 56

# ============================================================================
# VALIDATION RULES
# ============================================================================
# 1. All names MUST be Title Case for services, lowercase for topics
# 2. All dependencies MUST have source_file and source_line
# 3. No abbreviations allowed in names
# 4. Topics MUST use dot-notation (e.g., "order.completed")
# 5. Every async dependency MUST specify direction
# 6. Every sync dependency MUST specify type
